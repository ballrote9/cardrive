{% extends "base.html" %}
{% load static %}

{% block title %}
    <title>CarDrive - Бронирование Машин</title>
{% endblock title %}

{% block style %}
    <link rel="stylesheet" href="{% static "booking/style.css" %}">
    <link rel="stylesheet" href="{% static "base_styles.css" %}">
    <link rel="stylesheet" href="{% static "users/bootstrap.min.css"%}">
    <link rel="stylesheet" href="{% static "flatpickr.css"%}">
{% endblock style %}

{% block h1_title %}
    <h1>Бронирование</h1>
{% endblock h1_title %}

{% block content %}
<div class="container">
    <div class="booking-section">
        <h3>Информация о пользователе</h3>
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            {% if user.is_authenticated %}
            <div class="form-group">
                <p><strong>Фамилия:</strong> {{ user.last_name }}{% if form.last_name.errors %} <span class="text-danger">Изменения не применены</span>{% endif %}</p>
                <p><strong>Имя:</strong> {{ user.first_name }}{% if form.first_name.errors %} <span class="text-danger">Изменения не применены</span>{% endif %}</p>
                <p><strong>Отчество*:</strong>{% if user.middle_name %}{{ user.middle_name }}{% else %}<span class="placeholder-text">введите данные{% endif %}{% if form.middle_name.errors %} <span class="text-danger">Изменения не применены</span>{% endif %}</p>
                <p><strong>Серия и номер паспорта:</strong> {% if user.passport_num %}{{ user.passport_num }}{% else %}<span class="placeholder-text">введите данные{% endif %}{% if form.passport_num.errors %} <span class="text-danger">Изменения не применены</span>{% endif %}</p>
                <p><strong>Серия и номер водительского удостоверения:</strong> {% if user.drive_license_num %}{{ user.drive_license_num }}{% else %}<span class="placeholder-text">введите данные{% endif %}{% if form.drive_license_num.errors %} <span class="text-danger">Изменения не применены</span>{% endif %}</p>
                <p><strong>Имя пользователя:</strong> {{ user.username }}{% if form.username.errors %} <span class="text-danger">Изменения не применены</span>{% endif %}</p>
                <p><strong>Email:</strong> {{ user.email }}{% if form.email.errors %} <span class="text-danger">Изменения не применены</span>{% endif %}</p>
            </div>
            {% else %}
            <div class="form-group">
                <p><strong>Авторизуйтесь, пожалуйста!</strong></p>
            </div>
            {% endif %}
        </form>
    </div>

    <div class="booking-section">
        <h3>Информация о бронировании</h3>
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-group mb-3">
                <p><strong>Автомобиль:</strong> <a href="{% url 'cars:model_car' car.slug%}">{{ car.slug }}</a></p>
            </div>

            <div class="form-group mb-3">
                <label for="id_busy_start">Дата начала бронирования</label>
                <input type="date" class="form-control" placeholder="Выберите дату начала" id="id_busy_start" name="busy_start" value="{% if booking_form.busy_start.value %}{{ booking_form.busy_start.value }}{% endif %}">
                {% if booking_form.busy_start.errors %}
                <div class="alert alert-danger mt-2">{{ booking_form.busy_start.errors }}</div>
                {% endif %}
            </div>

            <div class="form-group mb-3">
                <label for="id_busy_end">Дата окончания бронирования</label>
                <input type="date" class="form-control" placeholder="Выберите дату окончания" id="id_busy_end" name="busy_end" value="{% if booking_form.busy_end.value %}{{ booking_form.busy_end.value }}{% endif %}">
                {% if booking_form.busy_end.errors %}
                <div class="alert alert-danger mt-2">{{ booking_form.busy_end.errors }}</div>
                {% endif %}
            </div>

            <div class="button-container">
                <button type="submit" class ="button">Забронировать</button>
                <button type="button"  name = "b" onclick="window.location.href='{% url 'cars:index' %}'">Отменить</button>
            </div>
            {% if messages %}
                <div class="alert alert-danger alert-dismissible fade show">
                    {% for message in messages %}
                        <p>{{ message }}</p>
                    {% endfor %}
                </div>
            {% endif %}
        </form>
    </div>

    <div class="order-summary">
        <h3>Информация о заказе</h3>
        <p><strong>Автомобиль:</strong> {{ car.designer }} {{ car.model }}</p>
        <p><strong>Количество дней аренды:</strong> <span id="rental-days">0</span> дней</p>
        <p><strong>Стоимость аренды:</strong> <span id="rental-cost">0</span> руб.</p>
        <p><strong>Адрес получения:</strong>Улица пушкина, д. 28а</p>
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const startDateInput = document.getElementById('id_busy_start');
        const endDateInput = document.getElementById('id_busy_end');
        const rentalDaysElement = document.getElementById('rental-days');
        const rentalCostElement = document.getElementById('rental-cost');
        
        // Стоимость аренды за день
        const dailyRate = Number({{car.price}}) ;  // Предполагаем, что car.price — это цена за день
    
        // Функция для расчета количества дней аренды и обновления стоимости
        function calculateRentalInfo() {
            console.log("Функция calculateRentalInfo запущена"); // Отладочный лог
    
            const startDateValue = startDateInput.value;
            const endDateValue = endDateInput.value;
    
            console.log("Выбрана дата начала:", startDateValue); // Лог для проверки значений
            console.log("Выбрана дата окончания:", endDateValue); // Лог для проверки значений
    
            // Проверка, что оба поля даты заполнены
            if (startDateValue && endDateValue) {
                const startDate = new Date(startDateValue);
                const endDate = new Date(endDateValue);
    
                console.log("Начальная дата:", startDate); // Лог даты
                console.log("Конечная дата:", endDate); // Лог даты
    
                // Проверяем, что дата окончания больше или равна дате начала
                if (endDate >= startDate) {
                    // Рассчитываем количество дней
                    const timeDiff = Math.abs(endDate - startDate);
                    const diffDays = Math.ceil(timeDiff / (1000 * 60 * 60 * 24)) || 1; // Минимум 1 день
    
                    console.log("Количество дней аренды:", diffDays); // Лог для проверки дней
    
                    // Обновляем количество дней на странице
                    rentalDaysElement.textContent = diffDays;
    
                    // Рассчитываем общую стоимость аренды
                    const totalCost = diffDays * dailyRate;
    
                    console.log("Общая стоимость аренды:", totalCost); // Лог для проверки стоимости
    
                    // Обновляем стоимость аренды на странице
                    rentalCostElement.textContent = totalCost.toLocaleString();
                } else {
                    alert("Дата окончания должна быть больше или равна дате начала.");
                    resetRentalInfo();
                }
            } else {
                console.log("Даты не выбраны корректно"); // Лог для отладки
                resetRentalInfo();
            }
        }
    
        // Сброс информации о заказе
        function resetRentalInfo() {
            rentalDaysElement.textContent = '0';
            rentalCostElement.textContent = '0';
        }
    
        // Добавляем обработчики событий на изменение дат
        startDateInput.addEventListener('change', calculateRentalInfo);
        endDateInput.addEventListener('change', calculateRentalInfo);
    }); 

</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const busyIntervals = {{ busy_intervals|safe }};  // Передаем занятые даты в формате JSON
    
        // Функция для преобразования даты из формата 'dd-mm-yyyy' в объект Date
        function parseDate(dateString) {
            const [day, month, year] = dateString.split('-').map(Number);
            return new Date(year, month - 1, day);
        }
    
        // Преобразуем занятые интервалы в массив блокируемых дат
        const disabledDates = busyIntervals.map(interval => {
            const start = parseDate(interval.start);
            const end = parseDate(interval.end);
    
            let dates = [];
            for (let d = start; d <= end; d.setDate(d.getDate() + 1)) {
                dates.push(new Date(d));
            }
            return dates;
        }).flat();  // Преобразуем интервалы в массив дат
    
        // Инициализация Flatpickr для поля даты начала
        flatpickr("#id_busy_start", {
            minDate: "today",  // Минимальная дата — сегодня
            disable: disabledDates,  // Блокируем занятые даты
            dateFormat: "Y-m-d",  // Формат даты
        });
    
        // Инициализация Flatpickr для поля даты окончания
        flatpickr("#id_busy_end", {
            minDate: "today",
            disable: disabledDates,
            dateFormat: "Y-m-d",
        });
    });
    
</script>
<script src={% static "scripts.js" %}></script>
<script src="{% static "flatpickr.js"%}"></script>
{% endblock scripts %}
